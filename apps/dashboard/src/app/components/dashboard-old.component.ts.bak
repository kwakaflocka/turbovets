import { Component, OnInit, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { CdkDragDrop, DragDropModule, moveItemInArray, transferArrayItem } from '@angular/cdk/drag-drop';
import { TaskService, Task } from '../services/task.service';
import { AuthService } from '../services/auth.service';
import { TaskCardComponent } from './task-card.component';
import { TaskModalComponent } from './task-modal.component';

@Component({
  selector: 'app-dashboard',
  standalone: true,
  imports: [CommonModule, FormsModule, DragDropModule, TaskCardComponent, TaskModalComponent],
  template: `
    <div class="min-h-screen bg-gray-50">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
              </div>
              <h1 class="ml-3 text-2xl font-bold text-gray-900">Task Manager</h1>
            </div>

            <div class="flex items-center gap-4">
              <div class="text-right">
                <p class="text-sm font-medium text-gray-900">{{ currentUser()?.email }}</p>
                <p class="text-xs text-gray-500 uppercase">{{ currentUser()?.role }}</p>
              </div>
              <button
                (click)="logout()"
                class="btn-secondary text-sm"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Controls Bar -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <!-- Filters -->
            <div class="flex flex-col sm:flex-row gap-3">
              <select
                [(ngModel)]="selectedCategory"
                (change)="applyFilters()"
                class="input-field max-w-xs"
              >
                <option value="">All Categories</option>
                @for (category of categories(); track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>

              <select
                [(ngModel)]="selectedStatus"
                (change)="applyFilters()"
                class="input-field max-w-xs"
              >
                <option value="">All Statuses</option>
                <option value="To Do">To Do</option>
                <option value="In Progress">In Progress</option>
                <option value="Done">Done</option>
              </select>
            </div>

            <!-- Create Task Button -->
            @if (canCreateTasks()) {
              <button
                (click)="openCreateModal()"
                class="btn-primary flex items-center gap-2"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Create Task
              </button>
            }
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="card">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">To Do</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">{{ getTaskCountByStatus('To Do') }}</p>
              </div>
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">In Progress</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">{{ getTaskCountByStatus('In Progress') }}</p>
              </div>
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-600">Done</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">{{ getTaskCountByStatus('Done') }}</p>
              </div>
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Kanban Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- To Do Column -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                To Do
              </h2>
              <span class="text-sm text-gray-500">{{ getTaskCountByStatus('To Do') }}</span>
            </div>

            <div
              cdkDropList
              #todoList="cdkDropList"
              [cdkDropListData]="todoTasks()"
              [cdkDropListConnectedTo]="[inProgressList, doneList]"
              (cdkDropListDropped)="drop($event)"
              class="min-h-[400px] space-y-3"
            >
              @for (task of todoTasks(); track task.id) {
                <div cdkDrag>
                  <app-task-card
                    [task]="task"
                    [canEdit]="canEditTask(task)"
                    [canDelete]="canDeleteTasks()"
                    (edit)="openEditModal(task)"
                    (delete)="deleteTask(task.id)"
                  ></app-task-card>
                </div>
              } @empty {
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                  <p class="text-sm">No tasks</p>
                </div>
              }
            </div>
          </div>

          <!-- In Progress Column -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                In Progress
              </h2>
              <span class="text-sm text-gray-500">{{ getTaskCountByStatus('In Progress') }}</span>
            </div>

            <div
              cdkDropList
              #inProgressList="cdkDropList"
              [cdkDropListData]="inProgressTasks()"
              [cdkDropListConnectedTo]="[todoList, doneList]"
              (cdkDropListDropped)="drop($event)"
              class="min-h-[400px] space-y-3"
            >
              @for (task of inProgressTasks(); track task.id) {
                <div cdkDrag>
                  <app-task-card
                    [task]="task"
                    [canEdit]="canEditTask(task)"
                    [canDelete]="canDeleteTasks()"
                    (edit)="openEditModal(task)"
                    (delete)="deleteTask(task.id)"
                  ></app-task-card>
                </div>
              } @empty {
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  <p class="text-sm">No tasks</p>
                </div>
              }
            </div>
          </div>

          <!-- Done Column -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                Done
              </h2>
              <span class="text-sm text-gray-500">{{ getTaskCountByStatus('Done') }}</span>
            </div>

            <div
              cdkDropList
              #doneList="cdkDropList"
              [cdkDropListData]="doneTasks()"
              [cdkDropListConnectedTo]="[todoList, inProgressList]"
              (cdkDropListDropped)="drop($event)"
              class="min-h-[400px] space-y-3"
            >
              @for (task of doneTasks(); track task.id) {
                <div cdkDrag>
                  <app-task-card
                    [task]="task"
                    [canEdit]="canEditTask(task)"
                    [canDelete]="canDeleteTasks()"
                    (edit)="openEditModal(task)"
                    (delete)="deleteTask(task.id)"
                  ></app-task-card>
                </div>
              } @empty {
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="text-sm">No tasks</p>
                </div>
              }
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Task Modal -->
    @if (showModal()) {
      <app-task-modal
        [task]="selectedTask()"
        [isOpen]="showModal()"
        (close)="closeModal()"
        (save)="saveTask($event)"
      ></app-task-modal>
    }
  `,
  styles: [`
    .cdk-drag-preview {
      opacity: 0.8;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .cdk-drag-animating {
      transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
    }

    .cdk-drop-list-dragging .cdk-drag {
      transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
    }
  `]
})
export class DashboardComponent implements OnInit {
  todoTasks = signal<Task[]>([]);
  inProgressTasks = signal<Task[]>([]);
  doneTasks = signal<Task[]>([]);
  categories = signal<string[]>([]);

  selectedCategory = '';
  selectedStatus = '';

  showModal = signal(false);
  selectedTask = signal<Task | null>(null);
  currentUser = signal<any>(null);

  constructor(
    private taskService: TaskService,
    private authService: AuthService
  ) {
    this.currentUser.set(this.authService.getCurrentUser());
  }

  ngOnInit(): void {
    this.loadTasks();

    // Subscribe to task updates
    this.taskService.tasks$.subscribe(tasks => {
      this.updateTaskLists(tasks);
      this.categories.set(this.taskService.getCategories());
    });
  }

  loadTasks(): void {
    this.taskService.getTasks().subscribe();
  }

  applyFilters(): void {
    const filters = {
      category: this.selectedCategory || undefined,
      status: this.selectedStatus || undefined
    };
    this.taskService.getTasks(filters).subscribe();
  }

  updateTaskLists(tasks: Task[]): void {
    this.todoTasks.set(tasks.filter(t => t.status === 'To Do'));
    this.inProgressTasks.set(tasks.filter(t => t.status === 'In Progress'));
    this.doneTasks.set(tasks.filter(t => t.status === 'Done'));
  }

  drop(event: CdkDragDrop<Task[]>): void {
    if (event.previousContainer === event.container) {
      moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
    } else {
      const task = event.previousContainer.data[event.previousIndex];
      const newStatus = this.getStatusFromList(event.container.element.nativeElement);

      if (newStatus && task.status !== newStatus) {
        this.taskService.updateTask(task.id, { status: newStatus }).subscribe(() => {
          transferArrayItem(
            event.previousContainer.data,
            event.container.data,
            event.previousIndex,
            event.currentIndex
          );
        });
      }
    }
  }

  private getStatusFromList(element: HTMLElement): string | null {
    const listId = element.id;
    if (listId.includes('todo')) return 'To Do';
    if (listId.includes('inProgress')) return 'In Progress';
    if (listId.includes('done')) return 'Done';

    // Fallback: check the header text
    const header = element.querySelector('h2');
    return header?.textContent?.trim() || null;
  }

  getTaskCountByStatus(status: string): number {
    switch (status) {
      case 'To Do': return this.todoTasks().length;
      case 'In Progress': return this.inProgressTasks().length;
      case 'Done': return this.doneTasks().length;
      default: return 0;
    }
  }

  openCreateModal(): void {
    this.selectedTask.set(null);
    this.showModal.set(true);
  }

  openEditModal(task: Task): void {
    this.selectedTask.set(task);
    this.showModal.set(true);
  }

  closeModal(): void {
    this.showModal.set(false);
    this.selectedTask.set(null);
  }

  saveTask(taskData: any): void {
    if (this.selectedTask()) {
      // Update existing task
      this.taskService.updateTask(this.selectedTask()!.id, taskData).subscribe(() => {
        this.closeModal();
      });
    } else {
      // Create new task
      this.taskService.createTask(taskData).subscribe(() => {
        this.closeModal();
      });
    }
  }

  deleteTask(taskId: string): void {
    if (confirm('Are you sure you want to delete this task?')) {
      this.taskService.deleteTask(taskId).subscribe();
    }
  }

  canCreateTasks(): boolean {
    return this.authService.canCreateTasks();
  }

  canDeleteTasks(): boolean {
    return this.authService.canDeleteTasks();
  }

  canEditTask(task: Task): boolean {
    const user = this.currentUser();
    if (!user) return false;

    // OWNER and ADMIN can edit any task
    if (this.authService.canEditAnyTask()) return true;

    // Users can edit their own tasks
    return task.createdById === user.id;
  }

  logout(): void {
    this.authService.logout();
  }
}
